(this.webpackJsonpmapbox=this.webpackJsonpmapbox||[]).push([[0],{19:function(e,t,a){},20:function(e,t,a){},26:function(e,t,a){"use strict";a.r(t);var n=a(5),i=a(4),s=a.n(i),r=a(10),o=a.n(r),c=(a(19),a(13)),l=a(3),h=a.n(l),u=(a(20),a(0)),d=a(1),m=a(2),f=a(7),p=a.n(f),g=a(11),v=a(12),y=a.n(v),b=a(23);function x(e){var t=this,a=e.target.getCenter(),n=Math.trunc(e.target.getZoom()),i=function(e,t,a){var n=s(e,-85.05112878,85.05112878),i=s(t,-180,180);return{x:Math.trunc(Math.pow(2,a)*((i+180)/360)),y:Math.trunc(Math.pow(2,a-1)*(1-Math.log(Math.tan(n*Math.PI/180)+1/Math.cos(n*Math.PI/180))/Math.PI))};function s(e,t,a){return Math.min(Math.max(e,t),a)}}(a.lat,a.lng,n),s=i.x,r=i.y;console.log("ZOOM",s,r,n,this.map),n>=13&&n<16&&(this.state.tilesLoaded.includes("".concat(s,"-").concat(r,"-").concat(n))||(this.state.tilesLoaded.push("".concat(s,"-").concat(r,"-").concat(n)),fetch("https://api.mapbox.com/v4/mapbox.mapbox-streets-v8/".concat(Math.floor(n),"/").concat(Math.floor(s),"/").concat(Math.floor(r),".mvt?access_token=").concat(h.a.accessToken)).then(function(){var e=Object(g.a)(p.a.mark((function e(a){var i,o;return p.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!a.ok){e.next=8;break}return e.next=3,a.arrayBuffer();case 3:i=e.sent,o=new b.VectorTile(new y.a(i)),t.state.buildings=t.state.buildings.concat(new Array(o.layers.building.length).fill(null).map((function(e,t){return o.layers.building.feature(t).toGeoJSON(s,r,n)}))),M.apply(t),console.log("Tile buildings",new Array(o.layers.building.length).fill(null).map((function(e,t){return o.layers.building.feature(t).toGeoJSON(s,r,n)})));case 8:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).catch((function(e){console.log(e.message),t.state.tilesLoaded.includes("".concat(s,"-").concat(r,"-").concat(n))&&t.state.tilesLoaded.filter((function(e){return e!=="".concat(s,"-").concat(r,"-").concat(n)}))}))))}function M(){var e=this;this.state.buildings.forEach((function(t,a){if(t&&t.properties&&"building"===t.properties.type&&!t.drawn){var n;switch(t.geometry.type){case"Polygon":n=[t.geometry.coordinates[0][0][0],t.geometry.coordinates[0][0][1]];break;case"MultiPolygon":n=[t.geometry.coordinates[0][0][0][0],t.geometry.coordinates[0][0][0][1]];break;default:n=null}if(!n)return;var i=l.MercatorCoordinate.fromLngLat(n),s={x:(i.x-e.origin.x)/e.scale,y:(i.y-e.origin.y)/e.scale};console.log("height",t.properties.height);var r=new m.a(10,10,3,32),o=new m.e({color:11184810,specular:"#cccccc",emissive:"#888888"}),c=new m.d(r,o);c.position.set(s.x,s.y,0),c.rotation.set(0,Math.PI/2,Math.PI/2),e.scene&&e.scene.add(c),e.state.buildings[a].drawn=!0,e.state.buildings[a].id=c.id}}))}var w=48.85827,j=2.29448;function k(e,t){if(t)for(var a=t/3/30;e.scale.y<t;)e.scale.y+=a;requestAnimationFrame((function(){k(e)}))}function O(){var e=Object(i.useState)(null),t=Object(c.a)(e,2),a=t[0],s=t[1],r=Object(i.useCallback)((function(e){if(e&&!a){var t=new h.a.Map({container:e,style:"mapbox://styles/mapbox/streets-v11",zoom:14,center:[j,w],pitch:40,antialias:!0});s(t)}}),[a]);return Object(i.useEffect)((function(){if(a)return a.on("load",L),a.on("mousemove",T),function(){a.off("load",L),a.off("move",I.loadTiles),a.off("mousemove",T)}}),[a]),Object(n.jsx)("div",{className:"p-8 pb-12 h-screen",children:Object(n.jsx)("div",{className:"h-full",ref:r})})}var I=new(function(){function e(t){Object(u.a)(this,e),this.id=void 0,this.renderingMode=void 0,this.type="custom",this.map=null,this.camera=null,this.scene=null,this.renderer=null,this.ready=!1,this.state=void 0,this.loadTiles=void 0,this.raycaster=new m.g,this.origin=void 0,this.scale=void 0,this.cameraTransform=void 0;var a=t.id,n=t.renderingMode;this.id=a,this.renderingMode=n,this.state={buildings:[],tilesLoaded:[]},this.loadTiles=x.bind(this),this.origin=l.MercatorCoordinate.fromLngLat([j,w],0),this.scale=this.origin.meterInMercatorCoordinateUnits();var i=this.origin,s=i.x,r=i.y,o=i.z,c=(new m.c).makeScale(this.scale,this.scale,-this.scale);this.cameraTransform=(new m.c).multiply(c).setPosition(s,r,o),this.raycaster.near=-1,this.raycaster.far=1e6}return Object(d.a)(e,[{key:"onAdd",value:function(e,t){this.map=e,this.camera=new m.f(28,this.map.transform.width/this.map.transform.height,1,1e6),this.scene=new m.h,this.renderer=new m.k({canvas:e.getCanvas(),context:t,antialias:!0}),this.renderer.autoClear=!1,this.map.on("move",this.loadTiles);var a=new m.b(16777215);a.position.set(0,-70,100).normalize(),this.scene.add(a);var n=new m.b(16777215);n.position.set(0,70,100).normalize(),this.scene.add(n)}},{key:"raycast",value:function(e){var t=this;if(this.camera&&this.scene&&this.map){var a=new m.i;a.x=e.x/this.map.transform.width*2-1,a.y=1-e.y/this.map.transform.height*2;var n=(new m.c).getInverse(this.camera.projectionMatrix),i=(new m.j).applyMatrix4(n),s=new m.j(a.x,a.y,1).applyMatrix4(n).clone().sub(i).normalize();this.raycaster.set(i,s);var r=this.raycaster.intersectObjects(this.scene.children,!0);r.forEach((function(e){var a=e.object.material,n=t.state.buildings.filter((function(t){return t.id===e.object.id}))[0];if(n&&n.properties){var i=n.properties.height;i<10?(a.color.setHex(170),a.emissive.setHex(136),a.specular.setHex(204)):i<100?(a.color.setHex(43520),a.emissive.setHex(34816),a.specular.setHex(52224)):(a.color.setHex(11141120),a.emissive.setHex(8912896),a.specular.setHex(13369344)),k(e.object,i)}})),r.length>0&&console.log("MOUSE",r[0].object.id)}}},{key:"render",value:function(e,t){this.map&&this.renderer&&this.scene&&this.camera&&(this.camera.projectionMatrix=(new m.c).fromArray(t).multiply(this.cameraTransform),this.renderer.state.reset(),this.renderer.render(this.scene,this.camera),this.map.triggerRepaint())}}]),e}())({id:"custom_buildings",renderingMode:"3d"});function L(e){console.log("Styles",e);var t=e.target;t.getLayer("custom_buildings")||t.addLayer(I)}function T(e){I.raycast(e.point)}var S=function(e){e&&e instanceof Function&&a.e(3).then(a.bind(null,27)).then((function(t){var a=t.getCLS,n=t.getFID,i=t.getFCP,s=t.getLCP,r=t.getTTFB;a(e),n(e),i(e),s(e),r(e)}))};h.a.accessToken="pk.eyJ1Ijoicm9tY2hhbWJlIiwiYSI6ImNraG42MnNmODA5Ymoyd2s4bGtocnR6MWcifQ.BUHBlSsIxk8pGk12tnqSUQ",o.a.render(Object(n.jsx)(s.a.StrictMode,{children:Object(n.jsx)(O,{})}),document.getElementById("root")),S()}},[[26,1,2]]]);
//# sourceMappingURL=main.041ad1e2.chunk.js.map